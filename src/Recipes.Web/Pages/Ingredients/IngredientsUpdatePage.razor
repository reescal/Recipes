@page "/Ingredients/Update/{Id:guid}"
@using Recipes.Data.Entities;
@using Recipes.Features.Ingredients.GetById;
@using Recipes.Features.Ingredients.Update;
@using Recipes.Web.Services;
@using Recipes.Web.Validation
@using static Recipes.Shared.Constants.Responses;
@inject IIngredientsService _ingredientsService
@inject IMessageService _message
@inject NavigationManager _navManager

@if(ingredient == null || ingredient?.Id == Guid.Empty)
{
    <GridRow Justify="center">
        <GridCol>
            <Spin Indicator="loadingIcon" />
        </GridCol>
    </GridRow>
}
else
{
    <GridRow>
        <GridCol Offset="8" Span="8">
            <Title Level="4" Style="text-align: center; border-bottom: 1px #1890FF solid">Update Ingredient</Title>
        </GridCol>
    </GridRow>
    <Form Model="@ingredientUpdate" @ref="@_form" LabelColSpan="2" WrapperColSpan="6" LabelColOffset="8" OnFinish="OnFinish">
        <Validator>
            <FluentValidationValidator />
        </Validator>
        <ChildContent>
            <FormItem Label="Image">
                <Input @bind-Value="context.Image" />
            </FormItem>
            <FormItem Label="Name">
                <Input @bind-Value="@context.Name" />
            </FormItem>
            <FormItem Label="Description">
                <TextArea @bind-Value="@context.Description" />
            </FormItem>
            <FormItem Label="Type">
                <AutoComplete @bind-Value="@context.Type" Options="@IngredientTypes" />
            </FormItem>
            <FormItem WrapperColOffset="10" WrapperColSpan="2">
                <Button Type="@ButtonType.Primary" HtmlType="submit" Disabled="submitDisabled">
                    Submit
                </Button>
            </FormItem>
        </ChildContent>
    </Form>
}

@code {
    [Parameter]
    public Guid Id { get; set; }
    private Form<IngredientUpdateRequest> _form;

    private IngredientUpdateRequest ingredientUpdate = new IngredientUpdateRequest();

    private IEnumerable<IngredientGetResponse> ingredients { get; set; } = new List<IngredientGetResponse>();
    private IngredientGetResponse ingredient { get; set; } = new();

    private bool submitDisabled;

    RenderFragment loadingIcon = @<Icon Type="loading" Theme="outline" Style="font-size: 24px" Spin />;

    protected override async Task OnInitializedAsync() => ingredients = await _ingredientsService.Get();

    protected override async Task OnParametersSetAsync()
    {
        ingredient = ingredients.FirstOrDefault(x => x.Id == Id);
        if(ingredient == null)
        {
            await _message.Error(NotFound(nameof(Ingredient), Id));
            _navManager.NavigateTo("/Ingredients");
        }
    }

    private HashSet<string> IngredientTypes => ingredients.Select(i => i.Type).ToHashSet();

    private async Task OnFinish(EditContext editContext)
    {
        submitDisabled = true;
        var result = await _ingredientsService.Update(ingredientUpdate);
        if (result.Valid)
        {
            await _message.Success(result.Message);
            _navManager.NavigateTo("/Ingredients");
        }
        else
        {
            var errors = result.Message.Split('\n');
            var tasks = new List<Task>();
            foreach (var error in errors)
            {
                tasks.Add(_message.Error(error));
            }
            await Task.WhenAll(tasks);
        }
        submitDisabled = false;
    }
}
